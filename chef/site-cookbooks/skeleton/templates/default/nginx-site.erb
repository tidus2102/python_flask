# Generated by Chef, do not edit
<%- server_name = node[:skeleton][:server_name] -%>
<%- flask_port = node[:skeleton][:flask_port] -%>
<%- log_dir = node[:skeleton][:log_dir] -%>
<%- site_dir = node[:skeleton][:site_dir] -%>
<%- socket_dir = node[:skeleton][:socket_dir] -%>
<%- app_name = node[:skeleton][:app_name] -%>

<%- ssl = node[:skeleton][:ssl] -%>
<%- if ssl -%>
# Redirect all HTTP traffic to HTTPS
server {
    server_name           <%= server_name %>;
    listen                80;
    return                301 https://<%= server_name %>$request_uri;
}
<%- end -%>

server {

    server_name           <%= server_name %>;
    listen                <%= ssl ? '443 ssl' : '80' %>;

    <%- if ssl -%>
    ssl_certificate       <%= ssl[:cert] %>;
    ssl_certificate_key   <%= ssl[:key] %>;
    <%- end -%>

    root                  <%= site_dir %>/static;
    access_log            <%= log_dir %>/access.log json;
    error_log             <%= log_dir %>/error.log;

    <%- if node[:skeleton][:blocked_keywords] -%>
    location ~* (<%= node[:skeleton][:blocked_keywords].join("|") %>) {
        return 444;
    }
    <%- end -%>

    location ~ \.(css|gif|jpeg|jpg|js|png)$ {
        expires           1w;
        try_files         $uri @skeleton;
    }

    location / {
        try_files         $uri @skeleton;
    }

    location @<%= app_name %> {
        proxy_set_header   Host $http_host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_redirect     off;
        include            uwsgi_params;
        uwsgi_pass         unix:<%= socket_dir %>/<%= app_name %>-uwsgi.sock;
    }
}

<%- if node[:skeleton][:enable_check_servername] -%>
server {
    listen                80 default;
    server_name           _;
    return                301 http://<%= server_name %>$1;
}
<%- end -%>
